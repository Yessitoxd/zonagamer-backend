<style>
    body {
        background: #4d248e;
    }
</style>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administrador</title>
    <link rel="icon" type="image/jpeg" href="Logo.jpg">
    <link rel="stylesheet" href="estilos_responsive.css">
    <style>
        /* Diseño de dos cuadros alineados horizontalmente, centrados verticalmente */
        .admin-panel-figma-layout {
            display: flex;
            flex-direction: row;
            align-items: stretch; /* Hace que ambos hijos tengan la misma altura */
            justify-content: center;
            gap: 32px;
            width: 90vw;
            height: 80vh;
            min-height: 600px;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        

        /* selectConsole moved to script block */
        .admin-figma-sidebar {
            background: linear-gradient(135deg, #2a114d 0%, #3b1d69 100%);
            border: 2.5px solid #3ef2e6;
            border-top-left-radius: 40px;
            border-bottom-left-radius: 40px;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            width: 220px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.25);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            gap: 0;
            overflow: hidden;
        }
        .admin-figma-mainbox {
            /* ====== FIN COPIA ESTILOS CUADROS ADMIN ====== */
            background: linear-gradient(135deg, #2a114d 0%, #3b1d69 100%);
            border: 2.5px solid #3ef2e6;
            border-radius: 32px;
            width: 800px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.45);
            display: flex;
            flex-direction: column;
            padding: 32px;
            color: #fff;
            max-height: 100%;
            overflow-y: auto;
        }
        @media (max-width: 700px) {
            .admin-panel-figma-layout {
                flex-direction: column;
                align-items: center;
                gap: 18px;
                margin-top: 32px;
            }
            .admin-figma-sidebar, .admin-figma-mainbox {
                width: 95vw;
                min-width: unset;
                max-width: 98vw;
                border-radius: 32px !important;
                height: 220px;
            }
        }
        /* Contenedor de los dos cuadros */
        .admin-main-layout {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: flex-start;
            gap: 32px;
            margin-top: 48px;
            width: 100%;
        }
        .admin-side-box {
            background: linear-gradient(135deg, #2a114d 0%, #3b1d69 100%);
            border: 2.5px solid #3ef2e6;
            border-radius: 18px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.45);
            width: 120px;
            min-width: 90px;
            height: 400px;
            max-height: 80vh;
            overflow-y: auto;
            color: #fff;
            padding: 18px 10px;
        }
        .admin-content-box {
            background: linear-gradient(135deg, #2a114d 0%, #3b1d69 100%);
            border: 2.5px solid #3ef2e6;
            border-radius: 18px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.45);
            width: 540px;
            min-width: 320px;
            height: 400px;
            max-height: 80vh;
            overflow-y: auto;
            color: #fff;
            padding: 32px 28px;
        }
        @media (max-width: 900px) {
            .admin-main-layout {
                flex-direction: column;
                align-items: center;
                gap: 18px;
            }
            .admin-content-box, .admin-side-box {
                width: 95vw;
                min-width: unset;
                max-width: 98vw;
            }
        }
        .sidebar-btn {
            width: 85%;
            min-width: 120px;
            max-width: 180px;
            margin: 0 auto;
            margin-bottom: 0;
            padding: 10px 0;
            background: transparent;
            color: #81fde9;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: color 0.2s, box-shadow 0.2s, background 0.2s;
            box-shadow: none;
            outline: none;
            text-align: center;
            white-space: normal;
            word-break: break-word;
            overflow: visible;
            display: block;
        }
        .sidebar-btn:hover, .sidebar-btn.active {
            background: #1a0733;
            color: #fff;
            box-shadow: 0 0 8px 2px #81fde9, 0 0 16px 2px #3ef2e6;
            border-radius: 10px;
        }
        .logout-btn {
            margin-top: auto;
            margin-bottom: 18px;
            width: 85%;
            min-width: 120px;
            max-width: 180px;
            padding: 10px 0;
            background: transparent;
            color: #81fde9;
            border: 2px solid #81fde9;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 0 8px 2px #81fde9, 0 0 16px 2px #3ef2e6;
            transition: box-shadow 0.2s, color 0.2s, background 0.2s;
            outline: none;
            text-align: center;
            white-space: normal;
            word-break: break-word;
            display: block;
        }
        .logout-btn:hover, .logout-btn.active {
            background: #1a0733;
            color: #fff;
            box-shadow: 0 0 8px 2px #81fde9, 0 0 16px 2px #3ef2e6;
            border-radius: 10px;
        }
        .admin-login-container .neon-anim-border .neon-stroke-2 {
            fill: none;
            stroke: #81fde9;
            stroke-width: 4;
            stroke-dasharray: 120, 1080;
            stroke-dashoffset: 600;
            filter: drop-shadow(0 0 8px #81fde9) drop-shadow(0 0 16px #81fde9);
            animation: neon-stroke-2 2.5s linear infinite;
        }
        @keyframes neon-stroke-1 {
            0% { stroke-dashoffset: 0; }
            100% { stroke-dashoffset: -1200; }
        }
        @keyframes neon-stroke-2 {
            0% { stroke-dashoffset: 600; }
            100% { stroke-dashoffset: -600; }
        }
        .admin-login-container {
            background: linear-gradient(135deg, #2a114d 0%, #3b1d69 100%);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 32px 32px 24px 32px;
            border-radius: 18px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.45);
            width: 350px;
            min-width: 280px;
            text-align: center;
            color: #fff;
            border: 2.5px solid #3ef2e6;
            z-index: 10;
            margin: 0;
        }
        @media (max-width: 600px) {
            .admin-login-container {
                width: 95vw;
                min-width: unset;
                padding: 18px 4vw 18px 4vw;
            }
        }
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #cccccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .input-group input:focus {
            outline: none;
            border-color: var(--main-color);
            box-shadow: 0 0 0 3px rgba(77, 36, 142, 0.2);
        }
        /* Botón de Iniciar Sesión (login) con efecto neón */
        #adminLoginForm button[type="submit"] {
            width: 100%;
            padding: 12px;
            background: transparent;
            color: #81fde9;
            border: 2px solid #81fde9;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 10px;
            box-shadow: 0 0 8px 2px #81fde9, 0 0 16px 2px #3ef2e6;
            transition: box-shadow 0.2s, color 0.2s, background 0.2s;
            outline: none;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
        }
        #adminLoginForm button[type="submit"]:hover, #adminLoginForm button[type="submit"]:focus {
            background: #1a0733;
            color: #fff;
            box-shadow: 0 0 16px 4px #81fde9, 0 0 32px 4px #3ef2e6;
        }

        .error-message {
            color: #ff4d4d;
            font-weight: bold;
            margin-top: 10px;
            text-align: center;
        }
        .admin-panel-sesiones {
            display: none;
            margin-top: 40px;
            width: 100%;
            max-width: 900px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .admin-panel-sesiones h2 {
            color: var(--accent-color);
            margin-bottom: 24px;
        }
        /* Neon select y input para añadir consola */
        .neon-select, .neon-input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            font-size: 16px;
            background: #2a114d;
            color: #81fde9;
            border: 2px solid #3ef2e6;
            box-shadow: 0 0 8px #3ef2e6, 0 0 16px #81fde9;
            outline: none;
            transition: box-shadow 0.2s, border-color 0.2s;
        }
        .neon-select:focus, .neon-input:focus {
            border-color: #81fde9;
            box-shadow: 0 0 16px 4px #81fde9, 0 0 32px 4px #3ef2e6;
        }
        .neon-select option {
            background: #1a0733;
            color: #81fde9;
        }
        /* Botón azul neón para añadir consola */
        .neon-btn {
            margin-top: 10px;
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #1a0733 0%, #3b1d69 100%);
            color: #81fde9;
            border: 2px solid #3ef2e6;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 0 8px 2px #3ef2e6, 0 0 16px 2px #81fde9;
            transition: box-shadow 0.2s, color 0.2s, background 0.2s;
            outline: none;
        }
        .neon-btn:hover, .neon-btn:focus {
            background: #2a114d;
            color: #fff;
            box-shadow: 0 0 16px 4px #81fde9, 0 0 32px 4px #3ef2e6;
        }
    </style>
</head>
<body>
    <!-- Logo eliminado -->
    <div class="admin-login-container" id="adminLoginContainer">
        <h2>Ingreso Administrador</h2>
        <form id="adminLoginForm">
            <div class="input-group">
                <label for="adminUsername">Usuario</label>
                <input type="text" id="adminUsername" name="adminUsername" placeholder="Usuario admin" required>
            </div>
            <div class="input-group">
                <label for="adminPassword">Contraseña</label>
                <input type="password" id="adminPassword" name="adminPassword" placeholder="Contraseña" required>
            </div>
            <p id="adminErrorMessage" class="error-message"></p>
            <button type="submit">Iniciar Sesión</button>
        </form>
    </div>
    <!-- Toast container -->
    <div id="toast-container" style="position:fixed;z-index:9999;bottom:32px;right:32px;display:flex;flex-direction:column;align-items:flex-end;gap:12px;pointer-events:none;"></div>
    <div id="adminPanelSesiones" style="display:none;">
        <div class="admin-panel-figma-layout">
            <div class="admin-figma-sidebar">
                <div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between;">
                    <div style="display: flex; flex-direction: column; flex: 1 1 auto; justify-content: flex-start; gap: 32px; padding-top: 24px; padding-bottom: 24px;">
                        <button class="sidebar-btn" onclick="showSession('reporte')" id="btn-reporte">Reporte<br>general</button>
                        <button class="sidebar-btn" onclick="showSession('descargar')" id="btn-descargar">Descargar<br>reporte</button>
                        <button class="sidebar-btn" onclick="showSession('consolas')" id="btn-consolas">Añadir<br>consolas</button>
                        <button class="sidebar-btn" onclick="showSession('precios')" id="btn-precios">Añadir<br>precios</button>
                    </div>
                    <button class="sidebar-btn logout-btn" onclick="window.location.href='Index.html'">Cerrar sesión</button>
                </div>
            </div>
            <div class="admin-figma-mainbox">
                <div id="mainbox-session-reporte" class="mainbox-session" style="display:block;">
                    <h2>Reporte General</h2>
                    <div id="consolesWrapper">
                        <!-- Horizontal scroller de consolas (predeterminado) -->
                        <div id="selectedConsolesBar" style="display:none;overflow-x:auto;white-space:nowrap;gap:12px;padding-bottom:8px;margin-bottom:12px;"><!-- kept for compatibility but unused --></div>
                        <div id="consolesList" style="display:flex;gap:24px;overflow-x:auto;overflow-y:visible;flex-wrap:nowrap;padding:12px 8px;align-items:center;"></div>
                    </div>
                    <!-- Embedded report area: will be populated when a console is opened -->
                    <div id="embeddedConsoleReport" style="display:none;margin-top:18px;background:rgba(0,0,0,0.12);padding:14px;border-radius:12px;">
                        <!-- Back button (top-right) -->
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <strong id="embeddedReportTitle" style="color:#81fde9;"></strong>
                            <button id="embeddedBackBtn" style="background:transparent;border:1.5px solid #81fde9;color:#81fde9;padding:6px 10px;border-radius:8px;cursor:pointer;">Limpiar selección</button>
                        </div>
                        <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;">
                            <label style="min-width:84px;color:#fff;">Fecha inicio:</label>
                            <input type="date" id="embeddedStartDate" style="padding:6px;border-radius:8px;border:1px solid #444;background:#fff;color:#000;" />
                            <label style="min-width:72px;color:#fff;margin-left:6px;">Fecha fin:</label>
                            <input type="date" id="embeddedEndDate" style="padding:6px;border-radius:8px;border:1px solid #444;background:#fff;color:#000;" />
                            <button id="embeddedFetchBtn" style="padding:6px 12px;border-radius:8px;background:#81fde9;border:none;cursor:pointer;color:#000;font-weight:700;margin-left:6px;">Buscar</button>
                        </div>
                        <div id="embeddedSessionsList" style="color:#fff;max-height:360px;overflow:auto;">
                            <div style="opacity:0.8;">Elige fechas y pulsa Buscar para ver sesiones.</div>
                        </div>
                    </div>
                </div>
                <div id="mainbox-session-descargar" class="mainbox-session" style="display:none;">
                    <h2>Descargar Reporte</h2>
                    <div style="color:#fff;opacity:0.9;margin-bottom:12px;">Selecciona una fecha o un rango y pulsa <strong>Descargar XLS</strong>. Esto usará una plantilla de Google Sheets (Apps Script) para generar el archivo.</div>
                    <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;">
                        <label style="color:#fff;">Desde</label>
                        <input type="date" id="downloadStartDate" style="padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:#fff;" />
                        <label style="color:#fff;">Hasta</label>
                        <input type="date" id="downloadEndDate" style="padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:#fff;" />
                        <button id="downloadReportBtn" class="neon-btn" style="width:auto;padding:8px 12px;">Descargar XLS</button>
                    </div>
                    <div id="downloadStatus" style="color:#fff;opacity:0.85;"></div>
                </div>
                <div id="mainbox-session-consolas" class="mainbox-session" style="display:none;">
                    <h2>Añadir Consolas</h2>
                    <div style="display:flex;flex-wrap:wrap;gap:32px;align-items:flex-start;">
                        <form id="addConsoleForm" style="margin-top:24px;max-width:340px;min-width:220px;flex:1;">
                            <div class="input-group">
                                <label for="consoleType">Consola</label>
                                <select id="consoleType" name="consoleType" required class="neon-select">
                                    <option value="">Selecciona una consola</option>
                                    <option value="ps5">Play Station 5</option>
                                    <option value="switch">Nintendo Switch</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="consoleNumber">Número de consola</label>
                                <input type="number" id="consoleNumber" name="consoleNumber" min="1" required placeholder="Ej: 1" class="neon-input">
                            </div>
                            <button type="submit" class="neon-btn">Añadir consola</button>
                            <p id="addConsoleMsg" class="error-message" style="margin-top:10px;"></p>
                        </form>
                        <div id="miniConsolesList" style="flex:2;display:flex;flex-wrap:wrap;gap:12px;align-items:flex-start;min-width:180px;"></div>
                    </div>
                </div>
                <div id="mainbox-session-precios" class="mainbox-session" style="display:none;">
                    <h2>Añadir Precios</h2>
                    <div style="display:flex;gap:32px;flex-wrap:wrap;justify-content:center;align-items:flex-start;">
                        <!-- Formulario PS5 -->
                        <div style="flex:1;min-width:260px;max-width:340px;">
                            <form id="addPriceForm-ps5" style="background:rgba(44,18,80,0.85);border-radius:14px;padding:18px 18px 12px 18px;box-shadow:0 0 8px #3ef2e6;margin-bottom:18px;">
                                <h3 style="color:#81fde9;margin-bottom:10px;">Play Station 5</h3>
                                <div class="input-group">
                                    <label for="ps5-minutes">Tiempo (minutos)</label>
                                    <input type="number" id="ps5-minutes" min="1" required class="neon-input" placeholder="Ej: 30">
                                </div>
                                <div class="input-group">
                                    <label for="ps5-price">Precio (C$)</label>
                                    <input type="number" id="ps5-price" min="1" required class="neon-input" placeholder="Ej: 50">
                                </div>
                                <button type="submit" class="neon-btn">Añadir precio</button>
                                <p id="ps5PriceMsg" class="error-message" style="margin-top:10px;"></p>
                            </form>
                            <div id="ps5-prices-list"></div>
                        </div>
                        <!-- Formulario Switch -->
                        <div style="flex:1;min-width:260px;max-width:340px;">
                            <form id="addPriceForm-switch" style="background:rgba(44,18,80,0.85);border-radius:14px;padding:18px 18px 12px 18px;box-shadow:0 0 8px #3ef2e6;margin-bottom:18px;">
                                <h3 style="color:#81fde9;margin-bottom:10px;">Nintendo Switch</h3>
                                <div class="input-group">
                                    <label for="switch-minutes">Tiempo (minutos)</label>
                                    <input type="number" id="switch-minutes" min="1" required class="neon-input" placeholder="Ej: 30">
                                </div>
                                <div class="input-group">
                                    <label for="switch-price">Precio (C$)</label>
                                    <input type="number" id="switch-price" min="1" required class="neon-input" placeholder="Ej: 50">
                                </div>
                                <button type="submit" class="neon-btn">Añadir precio</button>
                                <p id="switchPriceMsg" class="error-message" style="margin-top:10px;"></p>
                            </form>
                            <div id="switch-prices-list"></div>
                        </div>
                    </div>
                </div>
                <!-- FIN sección precios -->

<!-- El bloque de JS de precios está consolidado al final del archivo -->
    <script>
        // Mostrar consolas en tarjetas en Reporte General (sin editar/eliminar)
        async function renderConsolesList() {
            const list = document.getElementById('consolesList');
            if (!list) return;
            list.innerHTML = '<div style="color:#fff;opacity:0.7;">Cargando consolas...</div>';
            try {
                const res = await fetch('https://zonagamer-backend.onrender.com/consoles');
                const consolas = await res.json();
                if (!Array.isArray(consolas) || consolas.length === 0) {
                    list.innerHTML = '<div style="color:#fff;opacity:0.7;">No hay consolas registradas.</div>';
                    return;
                }
                // Ordenar por número
                consolas.sort((a, b) => a.number - b.number);
                list.innerHTML = consolas.map((c) => {
                    let nombre = c.type === 'ps5' ? 'Play Station 5' : (c.type === 'switch' ? 'Nintendo Switch' : c.type);
                    let img = c.type === 'ps5' ? 'PS5.png' : (c.type === 'switch' ? 'Switch.png' : '');
                    return `<div class="console-card-admin" data-type="${c.type}" data-number="${c.number}" style="flex:0 0 auto;background:rgba(44,18,80,0.95);border:2px solid #81fde9;border-radius:16px;padding:16px 14px 10px 14px;min-width:160px;max-width:200px;display:flex;flex-direction:column;align-items:center;box-shadow:0 0 8px #3ef2e6;position:relative;cursor:pointer;transition:transform 150ms ease, box-shadow 150ms ease;">
                        ${img ? `<img src='${img}' alt='${nombre}' style='width:80px;height:auto;margin-bottom:10px;'>` : ''}
                        <div style='font-weight:700;font-size:18px;color:#81fde9;margin-bottom:4px;'>${nombre} <span style="color:#fff;font-size:15px;">#${c.number}</span></div>
                    </div>`;
                }).join('');
                // Add hover/touch effect and click handlers
                document.querySelectorAll('.console-card-admin').forEach(card => {
                    card.addEventListener('mouseenter', () => {
                        card.style.transform = 'scale(1.03) translateY(-6px)';
                        card.style.boxShadow = '0 8px 24px rgba(0,0,0,0.4)';
                    });
                    card.addEventListener('mouseleave', () => {
                        card.style.transform = '';
                        card.style.boxShadow = '';
                    });
                        card.addEventListener('click', async (ev) => {
                            const type = card.dataset.type;
                            const number = card.dataset.number;
                            selectConsole(type, number, card);
                        });
                });
                    // After rendering, select the first console by default (if any)
                    const allCards = document.querySelectorAll('.console-card-admin');
                    if (allCards && allCards.length > 0) {
                        const first = allCards[0];
                        const t = first.dataset.type;
                        const n = first.dataset.number;
                        // slight delay to ensure inputs exist
                        setTimeout(() => selectConsole(t, n, first), 50);
                    }
                
            } catch (err) {
                list.innerHTML = '<div style="color:#fff;opacity:0.7;">Error al cargar consolas.</div>';
            }
        }

        function addToSelectedBar(type, number) {
            // No mostrar las píldoras: esta función ahora es intencionalmente NO-OP para evitar acumulación visual
            return;
        }

        function clearSelectedConsoles() {
            const bar = document.getElementById('selectedConsolesBar');
            if (!bar) return;
            bar.innerHTML = '';
            bar.style.display = 'none';
            document.getElementById('embeddedConsoleReport').style.display = 'none';
        }

        // Toast system
        function showToast(message, duration = 6000) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                min-width: 220px;
                max-width: 320px;
                background: rgba(44,18,80,0.97);
                color: #81fde9;
                border: 2px solid #3ef2e6;
                border-radius: 12px;
                padding: 14px 24px;
                margin-top: 0;
                font-size: 17px;
                font-weight: 600;
                box-shadow: 0 4px 24px #0008;
                opacity: 0;
                transform: translateY(20px);
                transition: opacity 0.3s, transform 0.3s;
                pointer-events: auto;
            `;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateY(0)';
            }, 50);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => container.removeChild(toast), 400);
            }, duration);
        }

        // Mostrar minitarjetas de consolas en sección Añadir Consolas
        async function renderMiniConsolesList() {
            const miniList = document.getElementById('miniConsolesList');
            if (!miniList) return;
            miniList.innerHTML = '<div style="color:#fff;opacity:0.7;">Cargando consolas...</div>';
            try {
                const res = await fetch('https://zonagamer-backend.onrender.com/consoles');
                const consolas = await res.json();
                if (!Array.isArray(consolas) || consolas.length === 0) {
                    miniList.innerHTML = '<div style="color:#fff;opacity:0.7;">No hay consolas registradas.</div>';
                    return;
                }
                // Filtrar solo consolas con _id válido (24 caracteres hex)
                const consolasValidas = consolas.filter(c => typeof c._id === 'string' && /^[a-fA-F0-9]{24}$/.test(c._id));
                consolasValidas.sort((a, b) => a.number - b.number);
                if (consolasValidas.length === 0) {
                    miniList.innerHTML = '<div style="color:#ff4d4d;opacity:0.85;">No hay consolas válidas para editar/eliminar.<br>Revisa los datos en la base.</div>';
                    return;
                }
                miniList.innerHTML = consolasValidas.map((c) => {
                    let nombre = c.type === 'ps5' ? 'PS5' : (c.type === 'switch' ? 'Switch' : c.type);
                    return `<div style="background:rgba(44,18,80,0.96);border:2px solid #81fde9;border-radius:12px;padding:14px 20px 12px 20px;min-width:120px;max-width:160px;display:flex;flex-direction:column;align-items:center;gap:6px;margin-bottom:10px;">
                        <div style='font-weight:700;font-size:18px;color:#fff;'>${nombre}</div>
                        <div style="color:#fff;font-size:15px;">#${c.number}</div>
                        <div style="display:flex;gap:10px;margin-top:8px;">
                            <button class="mini-edit-btn" data-id="${c._id}" style="padding:4px 14px;font-size:15px;border-radius:7px;border:1.5px solid #81fde9;background:#2a114d;color:#81fde9;cursor:pointer;">Editar</button>
                            <button class="mini-del-btn" data-id="${c._id}" style="padding:4px 14px;font-size:15px;border-radius:7px;border:1.5px solid #ff4d4d;background:#2a114d;color:#ff4d4d;cursor:pointer;">Eliminar</button>
                        </div>
                    </div>`;
                }).join('');
                // Botones editar/eliminar
                document.querySelectorAll('.mini-edit-btn').forEach(btn => {
                    btn.onclick = function() {
                        const id = this.dataset.id;
                        const consola = consolasValidas.find(c => c._id === id);
                        if (consola) showEditConsoleModal(consola);
                    };
                });
                document.querySelectorAll('.mini-del-btn').forEach(btn => {
                    btn.onclick = async function() {
                        const id = this.dataset.id;
                        if (confirm('¿Seguro que deseas eliminar esta consola?')) {
                            const delRes = await fetch('https://zonagamer-backend.onrender.com/consoles/' + id, { method: 'DELETE' });
                            if (delRes.ok) {
                                renderMiniConsolesList();
                                renderConsolesList();
                                showToast('Consola eliminada correctamente', 6000);
                            } else {
                                showToast('Error al eliminar consola.', 6000);
                            }
                        }
                    };
                });
            } catch (err) {
                miniList.innerHTML = '<div style="color:#fff;opacity:0.7;">Error al cargar consolas.</div>';
            }
        }

        // Modal para ver sesiones por consola y fecha
        function createSessionsModal() {
            if (document.getElementById('sessionsModal')) return; // already exists
            const modal = document.createElement('div');
            modal.id = 'sessionsModal';
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:9999;';
            modal.innerHTML = `
                <div style="background:#2a114d;color:#fff;border-radius:12px;padding:18px;min-width:320px;max-width:760px;max-height:80vh;overflow:auto;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                        <strong id="sessionsModalTitle">Sesiones</strong>
                        <button id="closeSessionsModal" style="background:#ff4d4d;border:none;padding:6px 10px;border-radius:8px;color:#fff;cursor:pointer;">Cerrar</button>
                    </div>
                    <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center;">
                        <label style="min-width:80px;">Fecha:</label>
                        <input type="date" id="sessionsDatePicker" style="padding:6px;border-radius:8px;border:1px solid #444;background:#fff;color:#000;" />
                        <button id="fetchSessionsBtn" style="padding:6px 12px;border-radius:8px;background:#81fde9;border:none;cursor:pointer;color:#000;font-weight:700;">Buscar</button>
                    </div>
                    <div id="sessionsListContainer" style="color:#fff;">
                        <div style="opacity:0.8;">Selecciona fecha y pulsa Buscar para ver sesiones.</div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('closeSessionsModal').addEventListener('click', () => modal.remove());
            document.getElementById('fetchSessionsBtn').addEventListener('click', async () => {
                const date = document.getElementById('sessionsDatePicker').value;
                const title = document.getElementById('sessionsModalTitle');
                const type = modal.dataset.type;
                const number = modal.dataset.number;
                if (!date) return alert('Elige una fecha');
                title.textContent = `Sesiones ${type} #${number} — ${date}`;
                const container = document.getElementById('sessionsListContainer');
                container.innerHTML = '<div style="opacity:0.8;">Cargando...</div>';
                try {
                    const res = await fetch(`https://zonagamer-backend.onrender.com/sessions?consoleType=${encodeURIComponent(type)}&consoleNumber=${encodeURIComponent(number)}&date=${encodeURIComponent(date)}`);
                    const sessions = await res.json();
                    if (!Array.isArray(sessions) || sessions.length === 0) {
                        container.innerHTML = '<div style="opacity:0.8;">No se encontraron sesiones para esa fecha.</div>';
                        return;
                    }
                    container.innerHTML = sessions.map(s => {
                        const start = s.startDate || '-';
                        const end = s.endDate || '-';
                        const total = s.totalPrice || 0;
                        return `<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.06);">Fecha inicio: ${start} — Fin: ${end} — Precio: C$ ${total}</div>`;
                    }).join('');
                } catch (e) {
                    container.innerHTML = '<div style="opacity:0.8;">Error cargando sesiones.</div>';
                }
            });
        }

        function openSessionsModal(type, number) {
            createSessionsModal();
            const modal = document.getElementById('sessionsModal');
            modal.dataset.type = type;
            modal.dataset.number = number;
            document.getElementById('sessionsDatePicker').value = new Date().toISOString().slice(0,10);
            document.body.style.overflow = 'hidden';
        }

        // Modal de edición de consola
                function showEditConsoleModal(consola) {
                        // Obtener username admin
                        const username = document.getElementById('adminUsername')?.value || 'Admin';
                        let modal = document.createElement('div');
                        modal.id = 'editConsoleModal';
                        modal.innerHTML = `
                                <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(20,10,40,0.75);z-index:9999;display:flex;align-items:center;justify-content:center;">
                                    <div style="background:linear-gradient(135deg,#2a114d 0%,#3b1d69 100%);border:2.5px solid #81fde9;border-radius:22px;box-shadow:0 0 32px #3ef2e6,0 0 64px #81fde9;padding:36px 32px 28px 32px;min-width:320px;max-width:95vw;display:flex;flex-direction:column;align-items:center;">
                                        <div style=\"font-size:20px;font-weight:700;color:#fff;margin-bottom:18px;text-align:center;\">${username}, ¿cómo deseas editar esta consola?</div>
                                        <form id=\"editConsoleForm\" style=\"width:100%;max-width:320px;display:flex;flex-direction:column;gap:18px;background:none;box-shadow:none;padding:0;\">
                                            <div class=\"input-group\" style=\"margin-bottom:10px;\">
                                                <label for=\"editConsoleType\" style=\"color:#fff;font-weight:500;\">Tipo de consola</label>
                                                <select id=\"editConsoleType\" required style=\"width:100%;padding:10px;border-radius:8px;font-size:16px;background:#2a114d;color:#fff;border:1.5px solid #bbb;box-shadow:none;outline:none;\">
                                                    <option value=\"ps5\" ${consola.type==='ps5'?'selected':''}>Play Station 5</option>
                                                    <option value=\"switch\" ${consola.type==='switch'?'selected':''}>Nintendo Switch</option>
                                                </select>
                                            </div>
                                            <div class=\"input-group\" style=\"margin-bottom:10px;\">
                                                <label for=\"editConsoleNumber\" style=\"color:#fff;font-weight:500;\">Número de consola</label>
                                                <input type=\"number\" id=\"editConsoleNumber\" min=\"1\" required value=\"${consola.number}\" style=\"width:100%;padding:10px;border-radius:8px;font-size:16px;background:#2a114d;color:#fff;border:1.5px solid #bbb;box-shadow:none;outline:none;\">
                                            </div>
                                            <div style=\"display:flex;gap:16px;justify-content:center;\">
                                                <button type=\"submit\" style=\"min-width:110px;padding:10px 0;background:#3b1d69;color:#fff;border:1.5px solid #81fde9;border-radius:8px;font-size:16px;font-weight:600;box-shadow:none;cursor:pointer;transition:background 0.2s;\">Confirmar</button>
                                                <button type=\"button\" id=\"cancelEditConsole\" style=\"min-width:110px;padding:10px 0;background:#444;color:#fff;border:1.5px solid #bbb;border-radius:8px;font-size:16px;font-weight:600;box-shadow:none;cursor:pointer;transition:background 0.2s;\">Cancelar</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                        `;
                        document.body.appendChild(modal);
                        document.getElementById('cancelEditConsole').onclick = () => {
                                modal.remove();
                        };
                        document.getElementById('editConsoleForm').onsubmit = async function(e) {
                                e.preventDefault();
                                const type = document.getElementById('editConsoleType').value;
                                const number = parseInt(document.getElementById('editConsoleNumber').value, 10);
                                // Validar número
                                if (!type || !number || number < 1) {
                                    showToast('Completa todos los campos correctamente.', 6000);
                                    return;
                                }
                                // PUT al backend
                                const res = await fetch('https://zonagamer-backend.onrender.com/consoles/' + consola._id, {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ type, number })
                                });
                                if (res.ok) {
                                    modal.remove();
                                    renderConsolesList();
                                    renderMiniConsolesList();
                                    showToast('Consola editada correctamente', 6000);
                                } else {
                                    showToast('Error al editar consola.', 6000);
                                }
                        };
                }
        // Renderizar al mostrar la sección reporte
        document.getElementById('btn-reporte').addEventListener('click', renderConsolesList);
        // Renderizar minitarjetas al mostrar sección consolas
        document.getElementById('btn-consolas').addEventListener('click', renderMiniConsolesList);
        // Renderizar al cargar la página si está activa
        document.addEventListener('DOMContentLoaded', function() {
            if (document.getElementById('mainbox-session-reporte').style.display !== 'none') {
                renderConsolesList();
            }
            if (document.getElementById('mainbox-session-consolas').style.display !== 'none') {
                renderMiniConsolesList();
            }
        });
        // Añadir consola: enviar al backend
        document.addEventListener('DOMContentLoaded', function() {
            const addConsoleForm = document.getElementById('addConsoleForm');
            if (addConsoleForm) {
                addConsoleForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const msg = document.getElementById('addConsoleMsg');
                    msg.textContent = '';
                    const type = document.getElementById('consoleType').value;
                    const number = parseInt(document.getElementById('consoleNumber').value, 10);
                    if (!type || !number || number < 1) {
                        msg.textContent = 'Completa todos los campos correctamente.';
                        return;
                    }
                    // Validar que el número no esté repetido
                    try {
                        const resConsolas = await fetch('https://zonagamer-backend.onrender.com/consoles');
                        const consolas = await resConsolas.json();
                        if (Array.isArray(consolas) && consolas.some(c => c.number === number)) {
                            msg.textContent = 'Ya existe una consola con ese número.';
                            return;
                        }
                    } catch (err) {
                        msg.textContent = 'Error validando número de consola.';
                        return;
                    }
                    // Enviar al backend
                    try {
                        const res = await fetch('https://zonagamer-backend.onrender.com/consoles', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ type, number })
                        });
                        if (res.ok) {
                            msg.style.color = '#81fde9';
                            msg.textContent = 'Consola añadida correctamente.';
                            addConsoleForm.reset();
                            renderMiniConsolesList();
                        } else {
                            const data = await res.json();
                            msg.textContent = data.message || 'Error al añadir consola.';
                        }
                    } catch (err) {
                        msg.textContent = 'Error de conexión con el servidor.';
                    }
                });
            }
        });
        // Cambia la sección visible en la mainbox y resalta el botón activo
        function showSession(session) {
            const sessions = ['reporte', 'descargar', 'consolas', 'precios'];
            sessions.forEach(s => {
                document.getElementById('mainbox-session-' + s).style.display = (s === session) ? 'block' : 'none';
                document.getElementById('btn-' + s).classList.toggle('active', s === session);
            });
        }
        // --- Embedded console report view helpers ---
        // Store previous mainbox content so we can restore it
        let _previousMainboxHTML = null;
        let _currentEmbeddedConsole = null; // {type, number}

        // Reusable selection function: highlights card, shows embedded report immediately
        function selectConsole(type, number, cardEl) {
            // highlight selected card visually
            document.querySelectorAll('.console-card-admin').forEach(c => c.style.boxShadow = '');
            if (cardEl) {
                cardEl.style.boxShadow = '0 10px 32px rgba(0,0,0,0.45)';
                // ensure it's visible in scroller
                try { cardEl.scrollIntoView({ behavior: 'smooth', inline: 'center' }); } catch(e){}
            }
            // add to selected bar
            addToSelectedBar(type, number);
            // show embedded report and set defaults
            _currentEmbeddedConsole = { type, number };
            const embedded = document.getElementById('embeddedConsoleReport');
            const titleEl = document.getElementById('embeddedReportTitle');
            const startInput = document.getElementById('embeddedStartDate');
            const endInput = document.getElementById('embeddedEndDate');
            const list = document.getElementById('embeddedSessionsList');
            if (!embedded || !titleEl || !startInput || !endInput || !list) return;
            let today;
            try { today = new Date().toLocaleString('sv-SE', { timeZone: 'America/Managua' }).split(' ')[0]; }
            catch { today = new Date().toISOString().slice(0,10); }
            titleEl.textContent = `${type.toUpperCase()} #${number} — Reporte`;
            startInput.value = today;
            endInput.value = today;
            list.innerHTML = '<div style="opacity:0.8;">Selecciona fechas o usa Buscar para ver sesiones.</div>';
            embedded.style.display = 'block';
            // Ensure controls visible (do not blur the grid)
            document.getElementById('consolesList').style.filter = '';
            // Replace Back button with Clear selection behavior
            // Keep the back button element but hide it visually for a cleaner embedded header
            const backBtn = document.getElementById('embeddedBackBtn');
            if (backBtn) {
                backBtn.style.display = 'none';
                backBtn.onclick = function() { clearSelectedConsoles(); };
            }
            // Ensure selectedConsolesBar remains hidden (we disabled pill UI in this build)
            const _scb2 = document.getElementById('selectedConsolesBar'); if (_scb2) _scb2.style.display = 'none';
            // Fetch handler
            document.getElementById('embeddedFetchBtn').onclick = async function() {
                const start = startInput.value;
                const end = endInput.value;
                if (!start || !end) return alert('Completa ambas fechas.');
                if (new Date(start) > new Date(end)) return alert('La fecha inicio debe ser anterior o igual a la fecha fin.');
                list.innerHTML = '<div style="opacity:0.8;">Cargando sesiones...</div>';
                await renderSessionsInMainbox(type, number, start, end);
            };
            // also automatically render today's sessions (best-effort)
            renderSessionsInMainbox(type, number, startInput.value, endInput.value);
        }

        async function renderSessionsInMainbox(type, number, start, end) {
            const container = document.getElementById('embeddedSessionsList');
            const titleEl = document.getElementById('embeddedReportTitle');
            if (!container) return;
            try {
                const url = `https://zonagamer-backend.onrender.com/sessions?consoleType=${encodeURIComponent(type)}&consoleNumber=${encodeURIComponent(number)}&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`;
                const res = await fetch(url);
                const sessions = await res.json();
                if (!Array.isArray(sessions) || sessions.length === 0) {
                    container.innerHTML = '<div style="opacity:0.8;">No se encontraron sesiones en ese rango.</div>';
                    // ajustar título según rango
                    titleEl.textContent = formatReportTitle(type, start, end);
                    return;
                }

                // Helpers
                function formatDateISO(iso) {
                    // Si ya viene en formato YYYY-MM-DD (clave usada para agrupar por Managua), formatear directamente
                    if (typeof iso === 'string' && iso.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        return iso.slice(8,10) + '-' + iso.slice(5,7) + '-' + iso.slice(0,4);
                    }
                    // intenta parsear y devolver dd-mm-aaaa (solo si incluye tiempo)
                    const d = new Date(iso);
                    if (!isNaN(d.getTime())) {
                        const dd = String(d.getDate()).padStart(2, '0');
                        const mm = String(d.getMonth() + 1).padStart(2, '0');
                        const yy = d.getFullYear();
                        return `${dd}-${mm}-${yy}`;
                    }
                    return iso || '-';
                }
                function formatTime(iso) {
                    if (!iso) return '-';
                    const d = new Date(iso);
                    if (!isNaN(d.getTime())) {
                        const prefers12h = /am|pm/i.test(new Date().toLocaleTimeString());
                        return d.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: prefers12h });
                    }
                    // si no es parseable, intenta extraer hora si existe
                    if (typeof iso === 'string') {
                        if (iso.length >= 19) return iso.slice(11,19);
                        if (iso.length >= 16) return iso.slice(11,16) + ':00';
                    }
                    return '-';
                }
                function formatDurationFriendly(seconds) {
                    if (!seconds && seconds !== 0) return '-';
                    const mins = Math.round(seconds / 60);
                    if (mins < 60) return `${mins} min`;
                    const h = Math.floor(mins / 60);
                    const m = mins % 60;
                    return m === 0 ? `${h} h` : `${h} h ${m} m`;
                }
                function formatMoney(v) {
                    if (typeof v === 'undefined' || v === null) return 'C$ 0';
                    return 'C$ ' + Number(v).toFixed(2).replace('.00','');
                }
                function formatReportTitle(type, sStart, sEnd) {
                    if (sStart === sEnd) return `Reporte del día ${sStart.split('-').reverse().join('-')}`;
                    return `Reporte del día ${sStart.split('-').reverse().join('-')} al día ${sEnd.split('-').reverse().join('-')}`;
                }

                // Agrupar por fecha en zona America/Managua para evitar desfase de un día
                const byDate = {};
                const toNicaDateKey = (iso) => {
                    if (!iso) return 'unknown';
                    try {
                        const d = new Date(iso);
                        if (isNaN(d.getTime())) return 'unknown';
                        const parts = d.toLocaleString('sv-SE', { timeZone: 'America/Managua' }).split(' ');
                        return parts[0];
                    } catch { return 'unknown'; }
                };
                sessions.forEach(s => {
                    const raw = s.startDate || s.createdAt || '';
                    const key = toNicaDateKey(raw);
                    if (!byDate[key]) byDate[key] = [];
                    byDate[key].push(s);
                });

                // obtener fechas ordenadas asc
                const dateKeys = Object.keys(byDate).filter(k => k !== 'unknown').sort();
                if (byDate['unknown']) dateKeys.push('unknown');

                // Totales generales para el rango (el endpoint ya filtró por consola)
                const totalUses = sessions.length;
                const totalSeconds = sessions.reduce((acc, s) => acc + (Number(s.durationSeconds) || 0), 0);
                const totalMoney = sessions.reduce((acc, s) => acc + (Number(s.totalPrice || s.total || 0) || 0), 0);

                // construir tabla HTML con cabeceras en el orden solicitado
                let html = `
                    <table style="width:100%;color:#fff;border-collapse:collapse;">
                        <thead style="background:rgba(44,18,80,0.95);">
                            <tr style="border-bottom:1px solid rgba(255,255,255,0.06);">
                                <th style="padding:8px;text-align:left;">Fecha</th>
                                <th style="padding:8px;text-align:left;">Empleado</th>
                                <th style="padding:8px;text-align:left;">Consola</th>
                                <th style="padding:8px;text-align:right;">Dinero generado</th>
                                <th style="padding:8px;text-align:right;">Tiempo</th>
                                <th style="padding:8px;text-align:left;">Inicio</th>
                                <th style="padding:8px;text-align:left;">Fin</th>
                                <th style="padding:8px;text-align:left;">Comentario</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                for (const dt of dateKeys) {
                    const items = byDate[dt];
                    // ordenar por startDate dentro de la fecha
                    items.sort((a,b) => {
                        const ta = new Date(a.startDate || a.createdAt || 0).getTime();
                        const tb = new Date(b.startDate || b.createdAt || 0).getTime();
                        return ta - tb;
                    });
                    for (const s of items) {
                        const fechaDisplay = dt === 'unknown' ? (s.startDate || '-') : formatDateISO(dt);
                        const empleado = s.employee || s.worker || s.username || s.fromConsole || '-';
                        const consola = (s.consoleType ? s.consoleType.toUpperCase() : '-') + (s.consoleNumber ? ' #' + s.consoleNumber : '');
                        const dinero = formatMoney(s.totalPrice || s.total || 0);
                        const tiempo = formatDurationFriendly(s.durationSeconds);
                        const inicio = formatTime(s.startDate);
                        const fin = formatTime(s.endDate);
                        const comentario = s.comment || s.action || '';
                        html += `<tr style="border-bottom:1px solid rgba(255,255,255,0.04);">
                                    <td style="padding:8px;vertical-align:top;">${fechaDisplay}</td>
                                    <td style="padding:8px;vertical-align:top;">${empleado}</td>
                                    <td style="padding:8px;vertical-align:top;">${consola}</td>
                                    <td style="padding:8px;text-align:right;vertical-align:top;">${dinero}</td>
                                    <td style="padding:8px;text-align:right;vertical-align:top;">${tiempo}</td>
                                    <td style="padding:8px;vertical-align:top;">${inicio}</td>
                                    <td style="padding:8px;vertical-align:top;">${fin}</td>
                                    <td style="padding:8px;vertical-align:top;white-space:nowrap;overflow:visible;text-overflow:ellipsis;max-width:420px;">${comentario || ''}</td>
                                </tr>`;
                    }
                }

                // Añadir fila de totales al final: colocar conteo de usos en columna Consola
                html += `<tr class="totals-row" style="font-weight:700;background:rgba(255,255,255,0.03);">
                            <td style="padding:8px;white-space:nowrap;width:18%;">Totales</td>
                            <td style="padding:8px;width:14%;"></td>
                            <td style="padding:8px;width:12%;text-align:left;">${totalUses}</td>
                            <td style="padding:8px;text-align:right;width:14%">${formatMoney(totalMoney)}</td>
                            <td style="padding:8px;text-align:right;width:12%">${formatDurationFriendly(totalSeconds)}</td>
                            <td style="padding:8px;width:12%;"></td>
                            <td style="padding:8px;width:10%;"></td>
                            <td style="padding:8px;width:8%;"></td>
                        </tr>`;
                html += `</tbody></table>`;
                container.innerHTML = html;

                // actualizar título con formato de rango
                titleEl.textContent = formatReportTitle(type, start, end);

            } catch (e) {
                container.innerHTML = '<div style="opacity:0.8;">Error cargando sesiones.</div>';
            }
        }

        function restoreMainboxView() {
            const embedded = document.getElementById('embeddedConsoleReport');
            if (embedded) embedded.style.display = 'none';
            const consolesList = document.getElementById('consolesList');
            if (consolesList) {
                consolesList.style.filter = '';
                // Optionally refresh list
                renderConsolesList();
            }
            _currentEmbeddedConsole = null;
        }
        // Login de admin conectado a backend (más robusto)
        document.addEventListener('DOMContentLoaded', function() {
            try {
                document.getElementById('adminPanelSesiones').style.display = 'none';
                const loginForm = document.getElementById('adminLoginForm');
                if (loginForm) {
                    loginForm.addEventListener('submit', async function(event) {
                        event.preventDefault();
                        const errorMsg = document.getElementById('adminErrorMessage');
                        errorMsg.textContent = '';
                        const username = document.getElementById('adminUsername').value;
                        const password = document.getElementById('adminPassword').value;
                        if (!username || !password) {
                            errorMsg.textContent = 'Completa todos los campos.';
                            return;
                        }
                        try {
                            const res = await fetch('https://zonagamer-backend.onrender.com/admins');
                            if (!res.ok) {
                                errorMsg.textContent = 'No se pudo conectar al backend.';
                                return;
                            }
                            const admins = await res.json();
                            if (!Array.isArray(admins)) {
                                errorMsg.textContent = 'Respuesta inesperada del servidor.';
                                return;
                            }
                            const admin = admins.find(a => a.username === username && a.password === password);
                            if (admin) {
                                document.getElementById('adminLoginContainer').style.display = 'none';
                                document.getElementById('adminPanelSesiones').style.display = 'block';
                            } else {
                                errorMsg.textContent = 'Usuario o contraseña incorrectos.';
                            }
                        } catch (err) {
                            errorMsg.textContent = 'Error de conexión con el servidor.';
                        }
                    });
                }
            } catch (e) {
                const errorMsg = document.getElementById('adminErrorMessage');
                if (errorMsg) errorMsg.textContent = 'Error inesperado en el login.';
            }
        });
    </script>
    <!-- Bloque de JS de precios (consolidado) -->
    <script>
    (function(){
        // Utilidad para mostrar minutos como "1 hora y 30 minutos" o "45 minutos"
        function formatMinutes(mins) {
            if (mins < 60) return mins + ' minutos';
            const h = Math.floor(mins / 60);
            const m = mins % 60;
            let str = h + ' hora' + (h > 1 ? 's' : '');
            if (m > 0) str += ' y ' + m + ' minutos';
            return str;
        }

        function renderPriceTable(prices, consoleType) {
            if (!prices || prices.length === 0) return '<div style="color:#fff;opacity:0.7;">No hay precios registrados.</div>';
            prices.sort((a, b) => a.duration - b.duration);
                return `<table style="width:100%;color:#fff;background:rgba(44,18,80,0.92);border-radius:10px;overflow:hidden;margin-bottom:10px;">
                    <tr style="background:#2a114d;color:#81fde9;font-weight:700;"><th>Tiempo</th><th>Precio (C$)</th><th>Acciones</th></tr>
                    ${prices.map(p => `
                        <tr>
                            <td>${formatMinutes(p.duration)}</td>
                            <td>${p.price}</td>
                            <td>
                                <div style="display:flex;gap:8px;justify-content:center;align-items:center;">
                                    <button onclick="editPrice('${p._id}','${consoleType}')" style="background:#2a114d;color:#81fde9;border:1.5px solid #81fde9;border-radius:6px;padding:3px 10px;cursor:pointer;">Editar</button>
                                    <button onclick="deletePrice('${p._id}','${consoleType}')" style="background:#2a114d;color:#ff4d4d;border:1.5px solid #ff4d4d;border-radius:6px;padding:3px 10px;cursor:pointer;">Eliminar</button>
                                </div>
                            </td>
                        </tr>`).join('')}
                </table>`;
        }

        async function renderPricesList() {
            try {
                const res = await fetch('https://zonagamer-backend.onrender.com/prices');
                if (!res.ok) throw new Error('fetch prices failed');
                const prices = await res.json();
                const ps5List = document.getElementById('ps5-prices-list');
                const switchList = document.getElementById('switch-prices-list');
                if (ps5List) ps5List.innerHTML = renderPriceTable(prices.filter(p => p.console === 'ps5'), 'ps5');
                if (switchList) switchList.innerHTML = renderPriceTable(prices.filter(p => p.console === 'switch'), 'switch');
            } catch (e) {
                const ps5List = document.getElementById('ps5-prices-list');
                const switchList = document.getElementById('switch-prices-list');
                if (ps5List) ps5List.innerHTML = '<div style="color:#fff;opacity:0.7;">Error cargando precios.</div>';
                if (switchList) switchList.innerHTML = '<div style="color:#fff;opacity:0.7;">Error cargando precios.</div>';
            }
        }

        // Añadir precio PS5
        document.addEventListener('DOMContentLoaded', function() {
            const formPs5 = document.getElementById('addPriceForm-ps5');
            if (formPs5) {
                formPs5.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const msg = document.getElementById('ps5PriceMsg');
                    if (msg) msg.textContent = '';
                    const minutes = parseInt(document.getElementById('ps5-minutes').value, 10);
                    const price = parseInt(document.getElementById('ps5-price').value, 10);
                    if (!minutes || !price || minutes < 1 || price < 1) {
                        if (msg) msg.textContent = 'Completa todos los campos correctamente.';
                        return;
                    }
                    try {
                        const res = await fetch('https://zonagamer-backend.onrender.com/prices', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ console: 'ps5', duration: minutes, price })
                        });
                        if (res.ok) {
                            if (msg) {
                                msg.style.color = '#81fde9';
                                msg.textContent = 'Precio añadido correctamente.';
                                setTimeout(() => { msg.textContent = ''; }, 3000);
                            }
                            formPs5.reset();
                            renderPricesList();
                        } else {
                            const data = await res.json();
                            if (msg) msg.textContent = data.message || 'Error al añadir precio.';
                        }
                    } catch (err) {
                        if (msg) msg.textContent = 'Error de conexión con el servidor.';
                    }
                });
            }

            // Añadir precio Switch
            const formSwitch = document.getElementById('addPriceForm-switch');
            if (formSwitch) {
                formSwitch.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const msg = document.getElementById('switchPriceMsg');
                    if (msg) msg.textContent = '';
                    const minutes = parseInt(document.getElementById('switch-minutes').value, 10);
                    const price = parseInt(document.getElementById('switch-price').value, 10);
                    if (!minutes || !price || minutes < 1 || price < 1) {
                        if (msg) msg.textContent = 'Completa todos los campos correctamente.';
                        return;
                    }
                    try {
                        const res = await fetch('https://zonagamer-backend.onrender.com/prices', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ console: 'switch', duration: minutes, price })
                        });
                        if (res.ok) {
                            if (msg) {
                                msg.style.color = '#81fde9';
                                msg.textContent = 'Precio añadido correctamente.';
                                setTimeout(() => { msg.textContent = ''; }, 3000);
                            }
                            formSwitch.reset();
                            renderPricesList();
                        } else {
                            const data = await res.json();
                            if (msg) msg.textContent = data.message || 'Error al añadir precio.';
                        }
                    } catch (err) {
                        if (msg) msg.textContent = 'Error de conexión con el servidor.';
                    }
                });
            }

            // Bind button to render prices when opening precios section
            const btnPrecios = document.getElementById('btn-precios');
            if (btnPrecios) btnPrecios.addEventListener('click', renderPricesList);

            // If precios section visible on load, render prices
            if (document.getElementById('mainbox-session-precios') && document.getElementById('mainbox-session-precios').style.display !== 'none') {
                renderPricesList();
            }
        });

        // Expose edit/delete globally so buttons in table can call them
        window.editPrice = function(id, consoleType) {
            const minutes = prompt('Nuevo tiempo en minutos:');
            const price = prompt('Nuevo precio en C$');
            if (!minutes || !price || isNaN(minutes) || isNaN(price) || minutes < 1 || price < 1) {
                if (typeof showToast === 'function') showToast('Datos inválidos.', 6000);
                return;
            }
            fetch('https://zonagamer-backend.onrender.com/prices', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify([{ _id: id, console: consoleType, duration: parseInt(minutes,10), price: parseInt(price,10) }])
            })
            .then(res => res.json())
            .then(() => {
                if (typeof showToast === 'function') showToast('Precio editado correctamente', 6000);
                renderPricesList();
            })
            .catch(() => { if (typeof showToast === 'function') showToast('Error al editar precio', 6000); });
        };

        window.deletePrice = function(id, consoleType) {
            if (!confirm('¿Seguro que deseas eliminar este precio?')) return;
            // backend supports DELETE /prices/:id
            fetch('https://zonagamer-backend.onrender.com/prices/' + id, { method: 'DELETE' })
            .then(res => res.json())
            .then(() => {
                if (typeof showToast === 'function') showToast('Precio eliminado correctamente', 6000);
                renderPricesList();
            })
            .catch(() => { if (typeof showToast === 'function') showToast('Error al eliminar precio', 6000); });
        };

    })();
    </script>
    <script>
    // CONFIG: URL del Apps Script Web App (insertado)
    const SHEETS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwl4CAW0eBxnwUgKYf9Eyk8zZQwziVgXYRlpJTVR4ZQb_wdOsLVNL0wZ4Uw1ZVemo_k/exec'; // Web App URL

    document.getElementById('downloadReportBtn').addEventListener('click', async function(){
        const start = document.getElementById('downloadStartDate').value;
        const end = document.getElementById('downloadEndDate').value || start;
        const status = document.getElementById('downloadStatus');
        status.textContent = '';
        if (!start) return alert('Selecciona al menos la fecha inicio');
        if (new Date(start) > new Date(end)) return alert('La fecha inicio debe ser anterior o igual a la fecha fin');
        if (!SHEETS_WEBAPP_URL) return alert('No está configurada la URL del WebApp de Google Sheets en el cliente. Pega la URL en la variable SHEETS_WEBAPP_URL.');

        status.textContent = 'Recopilando sesiones...';
        try {
            // fetch sessions for the range (all consoles)
            const res = await fetch(`https://zonagamer-backend.onrender.com/sessions?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`);
            const sessions = await res.json();
            if (!Array.isArray(sessions)) throw new Error('Respuesta inválida del servidor');

            // build rows matching columns C..J
            const rows = sessions.map(s => ({
                fecha: (s.startDate||'').slice(0,10),
                empleado: s.username || s.employee || '',
                consola: `${(s.consoleType||s.type||'').toString().toUpperCase()} ${s.consoleNumber || s.number || ''}`.trim(),
                dinero: Number(s.totalPrice||s.total||0),
                tiempo: s.durationFriendly || (s.durationSeconds? Math.round((s.durationSeconds||0)/60) + ' min' : ''),
                inicio: (s.startDate||'').slice(11,16) || '',
                fin: (s.endDate||'').slice(11,16) || '',
                comentario: s.comment || s.notes || ''
            }));

            const totalUses = sessions.length;
            const totalMoney = sessions.reduce((a,b) => a + (Number(b.totalPrice||b.total||0)||0), 0);

            const payload = {
                // you can optionally pass templateId here; otherwise set in Apps Script
                title: `Reporte ${start}` + (start !== end ? ` - ${end}` : ''),
                summary: { dayReportCellF5: `C$ ${totalMoney.toFixed(2)}`, dayTotalCellF8: `C$ ${totalMoney.toFixed(2)}` },
                rows: rows,
                totals: { totalUses: totalUses, totalMoney: totalMoney }
            };

            status.textContent = 'Generando archivo en Sheets...';
            // Post to backend proxy to avoid CORS issues. Use robust handling and fallback to absolute backend URL.
            const BACKEND_URL = 'https://zonagamer-backend.onrender.com';
            async function postGenerate(url) {
                const res = await fetch(url, { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
                if (!res.ok) {
                    const txt = await res.text().catch(()=>'');
                    throw new Error('HTTP ' + res.status + ' - ' + (txt || res.statusText));
                }
                const txt = await res.text();
                if (!txt) throw new Error('Empty response from server');
                try { return JSON.parse(txt); } catch(e) { throw new Error('Invalid JSON response: ' + txt); }
            }

            let json;
            try {
                json = await postGenerate('/generate-report');
            } catch (err) {
                console.warn('Relative /generate-report failed, retrying with BACKEND_URL:', err.message);
                json = await postGenerate(BACKEND_URL + '/generate-report');
            }

            if (json.error) throw new Error(json.error);
            status.innerHTML = 'Archivo listo: <a href="' + json.downloadUrl + '" target="_blank">Abrir XLSX</a>';
            // optionally auto-open
            window.open(json.downloadUrl, '_blank');
        } catch (err) {
            console.error(err);
            status.textContent = 'Error: ' + (err.message || err);
        }
    });
    </script>
</body>
</html>
